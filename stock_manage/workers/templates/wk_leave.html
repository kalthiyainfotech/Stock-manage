{% extends 'wk_base.html' %}
{% block wk_base %}

<main class="p-4 sm:p-6 lg:p-8 bg-slate-50 min-h-screen">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-5">
        <div>
            <h1 class="text-2xl font-semibold text-slate-900 tracking-tight">My Leaves</h1>
            <p class="mt-1 text-sm text-slate-500">Create and manage your leave requests.</p>
        </div>
        <button id="openLeaveModal"
            class="inline-flex items-center justify-center gap-2 rounded-lg bg-gradient-to-r from-slate-900 via-slate-800 to-slate-700 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:from-slate-800 hover:via-slate-700 hover:to-slate-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-500 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-50 transition">
            <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-white/10 text-xs border border-white/20">
                <i class="fa-solid fa-plus"></i>
            </span>
            <span>Add Leave</span>
        </button>
    </div>

    <div id="leaveModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50 px-3 sm:px-6">
        <div class="relative w-full max-w-2xl rounded-2xl bg-white shadow-xl shadow-slate-300/40 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between border-b border-slate-100 px-4 py-3 sm:px-6 sm:py-4 bg-slate-50/60 rounded-t-2xl">
                <div>
                    <h2 id="leaveModalTitle" class="text-base sm:text-lg font-semibold text-slate-900">Add Leave</h2>
                    <p class="mt-0.5 text-xs sm:text-sm text-slate-500">Fill the details to create or update a leave.</p>
                </div>
                <button id="closeLeaveModal" class="inline-flex h-8 w-8 items-center justify-center rounded-full text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition">
                    <span class="sr-only">Close</span>
                    ✕
                </button>
            </div>
            <div class="px-4 pb-4 pt-3 sm:px-6 sm:pb-6 sm:pt-4">
                <form id="leaveForm" method="POST" action="{% url 'wk_add_leave' %}" class="space-y-6">
                    {% csrf_token %}
                    <div class="space-y-3">
                        <h3 class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">Leave Details</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-700">Start date</label>
                                <input id="leaveStart" type="date" name="start_date" required
                                    class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-500/40">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-700">End date</label>
                                <input id="leaveEnd" type="date" name="end_date" required
                                    class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-500/40">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-700">Start time</label>
                                <input id="leaveStartTime" type="time" name="start_time" required step="60"
                                    class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-500/40">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-700">End time</label>
                                <input id="leaveEndTime" type="time" name="end_time" required step="60"
                                    class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-500/40">
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <h3 class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">Summary</h3>
                        <div class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 flex items-center justify-between">
                            <span class="text-sm font-medium text-slate-700">Total (estimated)</span>
                            <span id="leaveTotalPreview" class="text-sm font-semibold text-slate-900">—</span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <h3 class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">Other</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                            <div class="space-y-1.5">
                                <label class="text-xs font-medium text-slate-700">Category</label>
                                <select id="leaveCategory" name="category" required
                                        class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-500/40">
                                    <option value="">Select Category</option>
                                    <option value="Casual">Casual</option>
                                    <option value="Sick">Sick</option>
                                    <option value="Emergency">Emergency</option>
                                </select>
                            </div>
                            <div class="space-y-1.5 sm:col-span-2">
                                <label class="text-xs font-medium text-slate-700">Reason</label>
                                <textarea id="leaveReason" name="reason" rows="2" required
                                    placeholder="Reason for leave"
                                    class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-500/40 resize-none"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col-reverse gap-2 sm:flex-row sm:items-center sm:justify-end pt-2 border-t border-slate-100">
                        <button type="button" id="closeLeaveModalBottom"
                            class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50">
                            Cancel
                        </button>
                        <button type="submit"
                            class="inline-flex items-center justify-center gap-2 rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800">
                            <i class="fa-solid fa-floppy-disk text-xs"></i>
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="leaveDeleteModal" class="fixed inset-0 z-50 hidden bg-black/50">
        <div class="flex h-full w-full items-center justify-center px-4">
            <div class="w-full max-w-sm bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">Confirm Delete</h2>
                <p class="text-sm text-gray-600 mb-6">Are you sure you want to delete this leave?</p>
                <div class="flex justify-end gap-3">
                    <button type="button" id="closeLeaveDelete" class="px-4 py-2 text-sm bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
                    <a id="confirmLeaveDeleteBtn" class="px-4 py-2 text-sm bg-red-600 text-white rounded hover:bg-red-700">Delete</a>
                </div>
            </div>
        </div>
    </div>

    <section class="mt-5 rounded-xl border border-slate-200 bg-white/80 backdrop-blur-sm shadow-sm shadow-slate-100">
        <div class="flex flex-col gap-3 px-4 pt-4 pb-3 sm:flex-row sm:items-center sm:justify-between">
            <div class="space-y-0.5">
                <p class="text-xs font-medium uppercase tracking-[0.14em] text-slate-500">Overview</p>
                <p class="text-sm text-slate-500">
                    Showing
                    <span id="leaveVisibleCount" class="font-semibold text-slate-900">{{ leaves|length }}</span>
                    leaves.
                </p>
            </div>
            <div class="w-full sm:w-auto">
                <label class="relative block">
                    <span class="sr-only">Search leaves</span>
                    <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
                        <i class="fa-solid fa-magnifying-glass text-xs"></i>
                    </span>
                    <input
                        id="leaveSearch"
                        type="text"
                        placeholder="Search reason, category, status…"
                        class="w-full sm:w-64 rounded-lg border border-slate-200 bg-white px-8 py-2 text-xs sm:text-sm
                               text-slate-700 placeholder:text-slate-400 shadow-sm
                               focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-500/50">
                </label>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-xs sm:text-sm">
                <thead class="bg-slate-50 text-slate-700">
                    <tr>
                        <th class="px-4 py-3 text-left align-middle">Dates</th>
                        <th class="px-4 py-3 text-left align-middle">Times</th>
                        <th class="px-4 py-3 text-left align-middle">Total</th>
                        <th class="px-4 py-3 text-left align-middle">Category</th>
                        <th class="px-4 py-3 text-left align-middle">Reason</th>
                        <th class="px-4 py-3 text-center align-middle">Status</th>
                        <th class="px-4 py-3 text-center align-middle">Actions</th>
                    </tr>
                </thead>
                <tbody id="leavesTableBody" class="divide-y divide-slate-100">
                    {% for l in leaves %}
                    <tr data-leave-row class="hover:bg-slate-50">
                        <td class="px-4 py-3 align-middle text-slate-700">{{ l.start_date }} → {{ l.end_date }}</td>
                        <td class="px-4 py-3 align-middle text-slate-700">
                            {% if l.start_time or l.end_time %}
                            {{ l.start_time|time:"h:i A" }} → {{ l.end_time|time:"h:i A" }}
                            {% elif l.start_date == l.end_date %}
                            09:00 AM → 06:00 PM
                            {% else %}
                            Full day
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 align-middle text-slate-700">
                            {{ l.total_hm }}{% if l.start_date != l.end_date %} ({{ l.day_count }} days){% endif %}
                        </td>
                        <td class="px-4 py-3 align-middle">
                            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-[11px] font-semibold
                                {% if l.category == 'Casual' %}bg-slate-100 text-slate-800 ring-1 ring-slate-200{% endif %}
                                {% if l.category == 'Sick' %}bg-amber-100 text-amber-800 ring-1 ring-amber-200{% endif %}
                                {% if l.category == 'Emergency' %}bg-indigo-100 text-indigo-800 ring-1 ring-indigo-200{% endif %}">
                                {{ l.category }}
                            </span>
                        </td>
                        <td class="px-4 py-3 align-middle text-slate-700">{{ l.reason|default:"—" }}</td>
                        <td class="px-4 py-3 align-middle text-center">
                            <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[11px] font-semibold
                                {% if l.status == 'Pending' %}bg-amber-50 text-amber-700 ring-1 ring-amber-100{% endif %}
                                {% if l.status == 'Approved' %}bg-emerald-50 text-emerald-700 ring-1 ring-emerald-100{% endif %}
                                {% if l.status == 'Rejected' %}bg-rose-50 text-rose-700 ring-1 ring-rose-100{% endif %}">
                                <span class="h-1.5 w-1.5 rounded-full
                                    {% if l.status == 'Pending' %}bg-amber-500{% endif %}
                                    {% if l.status == 'Approved' %}bg-emerald-500{% endif %}
                                    {% if l.status == 'Rejected' %}bg-rose-500{% endif %}"></span>
                                {{ l.status }}
                            </span>
                        </td>
                        <td class="px-4 py-3 align-middle text-center">
                            <div class="inline-flex items-center justify-center gap-2">
                                {% if l.status == 'Pending' %}
                                <button onclick="openLeaveEdit(
                                        '{% url 'wk_edit_leave' l.id %}',
                                        '{{ l.start_date }}',
                                        '{{ l.end_date }}',
                                        '{{ l.start_time|time:"H:i" }}',
                                        '{{ l.end_time|time:"H:i" }}',
                                        '{{ l.category }}',
                                        '{{ l.reason|default:''|escapejs }}'
                                    )"
                                    class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-sky-200 bg-sky-50 text-sky-700 hover:bg-sky-100 hover:border-sky-300 transition"
                                    title="Edit">
                                    <i class="fa-solid fa-pen-to-square text-xs"></i>
                                    <span class="sr-only">Edit</span>
                                </button>
                                <button onclick="openLeaveDelete('{% url 'wk_delete_leave' l.id %}')"
                                    class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-rose-200 bg-rose-50 text-rose-700 hover:bg-rose-100 hover:border-rose-300 transition"
                                    title="Delete">
                                    <i class="fa-solid fa-trash text-xs"></i>
                                    <span class="sr-only">Delete</span>
                                </button>
                                {% else %}
                                <span class="text-xs text-slate-400">Locked</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-4 py-10 text-center text-slate-500">No leaves yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</main>

<script>
const leaveModal = document.getElementById('leaveModal');
const openLeaveModalBtn = document.getElementById('openLeaveModal');
const closeLeaveModalBtn = document.getElementById('closeLeaveModal');
const closeLeaveModalBottomBtn = document.getElementById('closeLeaveModalBottom');
const leaveForm = document.getElementById('leaveForm');
const leaveModalTitle = document.getElementById('leaveModalTitle');
const leaveStart = document.getElementById('leaveStart');
const leaveEnd = document.getElementById('leaveEnd');
const leaveReason = document.getElementById('leaveReason');
const leaveStartTime = document.getElementById('leaveStartTime');
const leaveEndTime = document.getElementById('leaveEndTime');
const leaveCategory = document.getElementById('leaveCategory');
const leaveTotalPreview = document.getElementById('leaveTotalPreview');

function hideLeaveModal() {
    leaveModal.classList.add('hidden');
    leaveModal.classList.remove('flex');
}
if (openLeaveModalBtn) {
    openLeaveModalBtn.onclick = () => {
        leaveForm.reset();
        leaveForm.action = "{% url 'wk_add_leave' %}";
        leaveModalTitle.innerText = "Add Leave";
        leaveModal.classList.remove('hidden');
        leaveModal.classList.add('flex');
        if (leaveTotalPreview) leaveTotalPreview.textContent = '—';
    };
}
if (closeLeaveModalBtn) closeLeaveModalBtn.onclick = hideLeaveModal;
if (closeLeaveModalBottomBtn) closeLeaveModalBottomBtn.onclick = hideLeaveModal;

function openLeaveEdit(editUrl, start, end, startTime, endTime, category, reason) {
    leaveModal.classList.remove('hidden');
    leaveModal.classList.add('flex');
    leaveModalTitle.innerText = "Edit Leave";
    leaveForm.action = editUrl;
    leaveStart.value = start;
    leaveEnd.value = end;
    leaveStartTime.value = startTime || '';
    leaveEndTime.value = endTime || '';
    leaveCategory.value = category || 'Casual';
    leaveReason.value = reason || '';
    recalcTotal();
}

const leaveDeleteModal = document.getElementById('leaveDeleteModal');
const confirmLeaveDeleteBtn = document.getElementById('confirmLeaveDeleteBtn');
function openLeaveDelete(deleteUrl) {
    leaveDeleteModal.classList.remove('hidden');
    leaveDeleteModal.classList.add('flex');
    confirmLeaveDeleteBtn.href = deleteUrl;
}
document.getElementById('closeLeaveDelete').onclick = () => {
    leaveDeleteModal.classList.add('hidden');
};

const leaveSearch = document.getElementById('leaveSearch');
if (leaveSearch) {
    leaveSearch.addEventListener('input', () => {
        const q = leaveSearch.value.trim().toLowerCase();
        const rows = document.querySelectorAll('#leavesTableBody tr[data-leave-row]');
        let visible = 0;
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const show = text.includes(q);
            row.style.display = show ? '' : 'none';
            if (show) visible++;
        });
        const countEl = document.getElementById('leaveVisibleCount');
        if (countEl) countEl.innerText = visible;
    });
}

function parseDate(v) {
    if (!v) return null;
    const d = new Date(v + 'T00:00:00');
    return isNaN(d.getTime()) ? null : d;
}
function parseTime(v) {
    if (!v) return null;
    const parts = v.split(':');
    if (parts.length < 2) return null;
    const h = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10);
    if (isNaN(h) || isNaN(m)) return null;
    return h * 60 + m;
}
function minutesDiff(d, m1, m2) {
    return Math.max(0, m2 - m1);
}
function recalcTotal() {
    const sd = parseDate(leaveStart.value);
    const ed = parseDate(leaveEnd.value);
    if (!sd || !ed || ed < sd) {
        if (leaveTotalPreview) leaveTotalPreview.textContent = '—';
        return;
    }
    const officeStart = 9 * 60;
    const lunchStart = 13 * 60;
    const lunchEnd = 14 * 60;
    const officeEnd = 18 * 60;
    const sInput = parseTime(leaveStartTime.value);
    const eInput = parseTime(leaveEndTime.value);
    let total = 0;
    const cur = new Date(sd);
    while (cur <= ed) {
        const isStartDay = cur.toDateString() === sd.toDateString();
        const isEndDay = cur.toDateString() === ed.toDateString();
        let s = isStartDay && sInput != null ? sInput : officeStart;
        let e = isEndDay && eInput != null ? eInput : officeEnd;
        s = Math.max(s, officeStart);
        e = Math.min(e, officeEnd);
        if (s < e) {
            let mins = minutesDiff(cur, s, e);
            const ls = Math.max(s, lunchStart);
            const le = Math.min(e, lunchEnd);
            if (ls < le) mins -= minutesDiff(cur, ls, le);
            total += Math.max(0, mins);
        }
        cur.setDate(cur.getDate() + 1);
    }
    const h = Math.floor(total / 60);
    const m = total % 60;
    if (leaveTotalPreview) leaveTotalPreview.textContent = `${h}h ${m}m`;
}
['change', 'input'].forEach(evt => {
    leaveStart.addEventListener(evt, recalcTotal);
    leaveEnd.addEventListener(evt, recalcTotal);
    leaveStartTime.addEventListener(evt, recalcTotal);
    leaveEndTime.addEventListener(evt, recalcTotal);
});
</script>

{% endblock wk_base %}
