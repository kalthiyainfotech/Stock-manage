{% extends "base.html" %}
{% block admin_dash %}

<main class="p-4 sm:p-6 lg:p-8 bg-slate-50 min-h-screen">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-5">
        <div>
            <h1 class="text-2xl font-semibold text-slate-900 tracking-tight">
                Orders
            </h1>
            <p class="mt-1 text-sm text-slate-500">
                Monitor all customer orders with status, totals, and quick actions.
            </p>
        </div>
    </div>

    <!-- Table Card -->
    <section
        class="mt-5 rounded-xl border border-slate-200 bg-white/80 backdrop-blur-sm shadow-sm shadow-slate-100">

        <!-- Table Top Bar -->
        <div class="flex flex-col gap-3 px-4 pt-4 pb-3 sm:flex-row sm:items-center sm:justify-between">
            <div class="space-y-0.5">
                <p class="text-xs font-medium uppercase tracking-[0.14em] text-slate-500">
                    Overview
                </p>
                <p class="text-sm text-slate-500">
                    Showing
                    <span class="font-semibold text-slate-900">
                        {{ orders.start_index }}–{{ orders.end_index }}
                    </span>
                    of
                    <span class="font-semibold text-slate-900">
                        {{ orders.paginator.count }}
                    </span>
                    orders.
                </p>
            </div>

            <!-- Simple client-side search (visual only) -->
            <div class="w-full sm:w-auto">
                <label class="relative block">
                    <span class="sr-only">Search orders</span>
                    <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
                        <i class="fa-solid fa-magnifying-glass text-xs"></i>
                    </span>
                    <input
                        id="orderSearch"
                        type="text"
                        placeholder="Search by order number, buyer, or email…"
                        class="w-full sm:w-72 rounded-lg border border-slate-200 bg-white px-8 py-2 text-xs sm:text-sm
                               text-slate-700 placeholder:text-slate-400 shadow-sm
                               focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-500/50">
                </label>
            </div>
        </div>

        <div class="overflow-x-auto border-t border-slate-100">
            <table class="min-w-full text-left text-sm text-slate-700">
                <thead
                    class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-xs uppercase tracking-wide text-slate-100">
                    <tr>
                        <th class="px-4 py-3 font-medium text-center">No.</th>
                        <th class="px-4 py-3 font-medium">Order Number</th>
                        <th class="px-4 py-3 font-medium">Buyer Name</th>
                        <th class="px-4 py-3 font-medium">Email</th>
                        <th class="px-4 py-3 font-medium text-right">Total</th>
                        <th class="px-4 py-3 font-medium text-center">Status</th>
                        <th class="px-4 py-3 font-medium whitespace-nowrap">Date</th>
                        <th class="px-4 py-3 font-medium text-center">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white">
                    {% for order in orders %}
                    <tr class="hover:bg-slate-50/80 transition-colors">
                        <td class="px-4 py-3 align-middle text-xs sm:text-sm text-slate-500 text-center">
                            {{ forloop.counter }}
                        </td>
                        <td class="px-4 py-3 align-middle text-xs sm:text-sm font-semibold text-blue-600">
                            {{ order.order_number }}
                        </td>
                        <td class="px-4 py-3 align-middle text-sm text-slate-800">
                            {{ order.first_name }} {{ order.last_name }}
                        </td>
                        <td class="px-4 py-3 align-middle text-xs sm:text-sm text-slate-500 whitespace-nowrap">
                            {{ order.email }}
                        </td>
                        <td class="px-4 py-3 align-middle text-xs sm:text-sm font-semibold text-slate-900 text-right">
                            ₹{{ order.total }}
                        </td>
                        <td class="px-4 py-3 align-middle text-center">
                            <span
                                class="inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[11px] font-semibold
                                {% if order.status == 'pending' %}
                                    bg-yellow-50 text-yellow-800 ring-1 ring-yellow-100
                                {% elif order.status == 'processing' %}
                                    bg-sky-50 text-sky-800 ring-1 ring-sky-100
                                {% elif order.status == 'shipped' %}
                                    bg-purple-50 text-purple-800 ring-1 ring-purple-100
                                {% elif order.status == 'delivered' %}
                                    bg-emerald-50 text-emerald-800 ring-1 ring-emerald-100
                                {% elif order.status == 'cancelled' %}
                                    bg-rose-50 text-rose-800 ring-1 ring-rose-100
                                {% else %}
                                    bg-slate-50 text-slate-700 ring-1 ring-slate-100
                                {% endif %}">
                                <span class="h-1.5 w-1.5 rounded-full
                                    {% if order.status == 'pending' %}
                                        bg-yellow-400
                                    {% elif order.status == 'processing' %}
                                        bg-sky-400
                                    {% elif order.status == 'shipped' %}
                                        bg-purple-400
                                    {% elif order.status == 'delivered' %}
                                        bg-emerald-500
                                    {% elif order.status == 'cancelled' %}
                                        bg-rose-500
                                    {% else %}
                                        bg-slate-400
                                    {% endif %}"></span>
                                {{ order.get_status_display }}
                            </span>
                        </td>
                        <td class="px-4 py-3 align-middle text-xs sm:text-sm text-slate-500 whitespace-nowrap">
                            {{ order.created_at|date:"Y-m-d H:i" }}
                        </td>
                        <td class="px-4 py-3 align-middle text-center">
                            <div class="inline-flex items-center justify-center gap-2">
                            <button
                                onclick="openViewModal(
                                    '{{ order.id }}',
                                    '{{ order.order_number }}',
                                    '{{ order.first_name }}',
                                    '{{ order.last_name }}',
                                    '{{ order.email }}',
                                    '{{ order.phone }}',
                                    '{{ order.address|escapejs }}',
                                    '{% if order.address_line2 %}{{ order.address_line2|escapejs }}{% endif %}',
                                    '{{ order.city }}',
                                    '{{ order.state }}',
                                    '{{ order.postal_code }}',
                                    '{{ order.country }}',
                                    '{{ order.subtotal }}',
                                    '{{ order.total }}',
                                    '{{ order.get_payment_method_display }}',
                                    '{{ order.get_status_display }}',
                                    '{{ order.created_at|date:"Y-m-d H:i" }}',
                                    '{% if order.order_notes %}{{ order.order_notes|escapejs }}{% else %}N/A{% endif %}',
                                    '{{ order.ship_to_different_address }}',
                                    '{% if order.shipping_first_name %}{{ order.shipping_first_name }}{% endif %}',
                                    '{% if order.shipping_last_name %}{{ order.shipping_last_name }}{% endif %}',
                                    '{% if order.shipping_address %}{{ order.shipping_address|escapejs }}{% endif %}',
                                    '{% if order.shipping_city %}{{ order.shipping_city }}{% endif %}',
                                    '{% if order.shipping_state %}{{ order.shipping_state }}{% endif %}',
                                    '{% if order.shipping_postal_code %}{{ order.shipping_postal_code }}{% endif %}',
                                    '{% if order.shipping_country %}{{ order.shipping_country }}{% endif %}',
                                    '{% for item in order.items.all %}{{ item.product_name|escapejs }}|{{ item.quantity }}|{{ item.price }}|{{ item.total }}{% if not forloop.last %}|||{% endif %}{% endfor %}'
                                )"
                                class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-emerald-200 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 hover:border-emerald-300 transition"
                                title="View">
                                <i class="fa-solid fa-eye text-xs"></i>
                                <span class="sr-only">View</span>
                            </button>
                            <button
                                onclick="openDeleteModal('{% url 'delete_order' order.id %}')"
                                class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-rose-200 bg-rose-50 text-rose-700 hover:bg-rose-100 hover:border-rose-300 transition"
                                title="Delete">
                                <i class="fa-solid fa-trash text-xs"></i>
                                <span class="sr-only">Delete</span>
                            </button>
                        </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="px-4 py-3 text-center text-gray-500">
                            No orders yet.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </section>

    <!-- Pagination -->
    {% if orders.has_other_pages %}
    <div class="mt-6 flex justify-end mb-4 mr-4">
        <nav class="flex items-center gap-1 p-2 rounded">
            {% if orders.has_previous %}
                <a href="?page={{ orders.previous_page_number }}"
                   class="h-9 w-9 flex items-center justify-center rounded border border-gray-300 hover:bg-gray-100">
                    ‹
                </a>
            {% else %}
                <span class="h-9 w-9 flex items-center justify-center rounded border border-gray-200 text-gray-400">
                    ‹
                </span>
            {% endif %}

            {% for num in orders.paginator.page_range %}
                {% if num == orders.number %}
                    <span class="h-9 w-9 flex items-center justify-center rounded bg-slate-900 text-white font-medium">
                        {{ num }}
                    </span>
                {% elif num > orders.number|add:'-2' and num < orders.number|add:'2' %}
                    <a href="?page={{ num }}"
                       class="h-9 w-9 flex items-center justify-center rounded border border-gray-300 hover:bg-gray-100">
                        {{ num }}
                    </a>
                {% elif num == 1 or num == orders.paginator.num_pages %}
                    <a href="?page={{ num }}"
                       class="h-9 w-9 flex items-center justify-center rounded border border-gray-300 hover:bg-gray-100">
                        {{ num }}
                    </a>
                {% elif num == orders.number|add:'-3' or num == orders.number|add:'3' %}
                    <span class="px-2">…</span>
                {% endif %}
            {% endfor %}

            {% if orders.has_next %}
                <a href="?page={{ orders.next_page_number }}"
                   class="h-9 w-9 flex items-center justify-center rounded border border-gray-300 hover:bg-gray-100">
                    ›
                </a>
            {% else %}
                <span class="h-9 w-9 flex items-center justify-center rounded border border-gray-200 text-gray-400">
                    ›
                </span>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</main>

<!-- View Order Modal -->
<div id="viewModal"
     class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 px-3 sm:px-6">
    <div class="bg-white w-full max-w-4xl rounded-xl p-5 sm:p-6 relative max-h-[90vh] overflow-y-auto">
        <!-- Close Button -->
        <button onclick="closeViewModal()"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl">
            ✖
        </button>

        <!-- Content -->
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Order Details</h2>

        <div class="space-y-6">
            <!-- Order Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-600"><strong>Order Number:</strong></p>
                    <p id="viewOrderNumber" class="text-lg font-semibold text-blue-600"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-600"><strong>Order Date:</strong></p>
                    <p id="viewOrderDate" class="text-lg"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-600"><strong>Status:</strong></p>
                    <p id="viewStatus" class="text-lg font-semibold"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-600"><strong>Payment Method:</strong></p>
                    <p id="viewPaymentMethod" class="text-lg"></p>
                </div>
            </div>

            <!-- Billing Details -->
            <div class="border-t pt-4">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Billing Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600"><strong>Name:</strong></p>
                        <p id="viewFirstName" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600"><strong>Email:</strong></p>
                        <p id="viewEmail" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600"><strong>Phone:</strong></p>
                        <p id="viewPhone" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600"><strong>Address:</strong></p>
                        <p id="viewAddress" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600"><strong>City:</strong></p>
                        <p id="viewCity" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600"><strong>State:</strong></p>
                        <p id="viewState" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600"><strong>Postal Code:</strong></p>
                        <p id="viewPostalCode" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600"><strong>Country:</strong></p>
                        <p id="viewCountry" class="text-base"></p>
                    </div>
                </div>
            </div>

            <!-- Shipping Details (if different) -->
            <div id="shippingSection" class="border-t pt-4 hidden">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Shipping Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600"><strong>Name:</strong></p>
                        <p id="viewShippingName" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600"><strong>Address:</strong></p>
                        <p id="viewShippingAddress" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600"><strong>City:</strong></p>
                        <p id="viewShippingCity" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600"><strong>State:</strong></p>
                        <p id="viewShippingState" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600"><strong>Postal Code:</strong></p>
                        <p id="viewShippingPostalCode" class="text-base"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600"><strong>Country:</strong></p>
                        <p id="viewShippingCountry" class="text-base"></p>
                    </div>
                </div>
            </div>

            <!-- Order Items -->
            <div class="border-t pt-4">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Order Items</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full border border-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-sm">Product</th>
                                <th class="px-4 py-2 text-left text-sm">Quantity</th>
                                <th class="px-4 py-2 text-left text-sm">Price</th>
                                <th class="px-4 py-2 text-left text-sm">Total</th>
                            </tr>
                        </thead>
                        <tbody id="viewOrderItems">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="border-t pt-4">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Order Summary</h3>
                <div class="flex justify-end">
                    <div class="w-full max-w-xs space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal:</span>
                            <span id="viewSubtotal" class="font-semibold"></span>
                        </div>
                        <div class="flex justify-between text-lg font-bold">
                            <span>Total:</span>
                            <span id="viewTotal" class="text-blue-600"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Notes -->
            <div class="border-t pt-4">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Order Notes</h3>
                <p id="viewOrderNotes" class="text-gray-600"></p>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal"
     class="fixed inset-0 z-50 hidden bg-black/50">
    <div class="flex h-full w-full items-center justify-center px-4">
        <div class="w-full max-w-sm bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">
                Confirm Delete
            </h2>
            <p class="text-sm text-gray-600 mb-6">
                Are you sure you want to delete this order? This action cannot be undone.
            </p>
            <div class="flex justify-end gap-3">
                <button
                    type="button"
                    onclick="closeDeleteModal()"
                    class="px-4 py-2 text-sm bg-gray-200 rounded hover:bg-gray-300">
                    Cancel
                </button>
                <a id="confirmDeleteBtn"
                   class="px-4 py-2 text-sm bg-red-600 text-white rounded hover:bg-red-700">
                    Delete
                </a>
            </div>
        </div>
    </div>
</div>

<script>
const viewModal = document.getElementById('viewModal');
const deleteModal = document.getElementById('deleteModal');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

function openViewModal(
    id, orderNumber, firstName, lastName, email, phone,
    address, addressLine2, city, state, postalCode, country,
    subtotal, total, paymentMethod, status, orderDate, orderNotes,
    shipToDifferent, shippingFirstName, shippingLastName,
    shippingAddress, shippingCity, shippingState, shippingPostalCode, shippingCountry,
    itemsString
) {
    // Order Info
    document.getElementById('viewOrderNumber').innerText = orderNumber;
    document.getElementById('viewOrderDate').innerText = orderDate;
    document.getElementById('viewStatus').innerText = status;
    document.getElementById('viewPaymentMethod').innerText = paymentMethod;

    // Billing Details
    document.getElementById('viewFirstName').innerText = firstName + ' ' + lastName;
    document.getElementById('viewEmail').innerText = email;
    document.getElementById('viewPhone').innerText = phone;
    let fullAddress = address;
    if (addressLine2) fullAddress += ', ' + addressLine2;
    document.getElementById('viewAddress').innerText = fullAddress;
    document.getElementById('viewCity').innerText = city;
    document.getElementById('viewState').innerText = state;
    document.getElementById('viewPostalCode').innerText = postalCode;
    document.getElementById('viewCountry').innerText = country;

    // Shipping Details
    if (shipToDifferent === 'True' && shippingAddress) {
        document.getElementById('shippingSection').classList.remove('hidden');
        document.getElementById('viewShippingName').innerText = (shippingFirstName || '') + ' ' + (shippingLastName || '');
        document.getElementById('viewShippingAddress').innerText = shippingAddress || 'N/A';
        document.getElementById('viewShippingCity').innerText = shippingCity || 'N/A';
        document.getElementById('viewShippingState').innerText = shippingState || 'N/A';
        document.getElementById('viewShippingPostalCode').innerText = shippingPostalCode || 'N/A';
        document.getElementById('viewShippingCountry').innerText = shippingCountry || 'N/A';
    } else {
        document.getElementById('shippingSection').classList.add('hidden');
    }

    // Order Items
    const itemsTable = document.getElementById('viewOrderItems');
    itemsTable.innerHTML = '';
    if (itemsString) {
        const items = itemsString.split('|||');
        items.forEach(itemStr => {
            if (itemStr) {
                const [productName, quantity, price, itemTotal] = itemStr.split('|');
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="px-4 py-2">${productName}</td>
                    <td class="px-4 py-2">${quantity}</td>
                    <td class="px-4 py-2">₹${price}</td>
                    <td class="px-4 py-2 font-semibold">₹${itemTotal}</td>
                `;
                itemsTable.appendChild(row);
            }
        });
    }

    // Order Summary
    document.getElementById('viewSubtotal').innerText = '₹' + subtotal;
    document.getElementById('viewTotal').innerText = '₹' + total;

    // Order Notes
    document.getElementById('viewOrderNotes').innerText = orderNotes || 'No notes';

    viewModal.classList.remove('hidden');
    viewModal.classList.add('flex');
}

function closeViewModal() {
    viewModal.classList.add('hidden');
}

function openDeleteModal(deleteUrl) {
    deleteModal.classList.remove('hidden');
    deleteModal.classList.add('flex');
    confirmDeleteBtn.href = deleteUrl;
}

function closeDeleteModal() {
    deleteModal.classList.add('hidden');
}
</script>

{% endblock %}
