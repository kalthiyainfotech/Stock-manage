{% extends "base.html" %}
{% block admin_dash %}

<main class="p-4 sm:p-6 lg:p-8 bg-slate-50 min-h-screen overflow-x-hidden">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-5">
        <div>
            <h1 class="text-2xl font-semibold text-slate-900 tracking-tight">Leaves</h1>
            <p class="mt-1 text-sm text-slate-500">Manage worker leave requests.</p>
        </div>
    </div>

    <section class="mt-5 rounded-xl border border-slate-200 bg-white/80 backdrop-blur-sm shadow-sm shadow-slate-100">
        <div class="flex flex-col gap-3 px-4 pt-4 pb-3 sm:flex-row sm:items-center sm:justify-between">
            <div class="space-y-0.5">
                <p class="text-xs font-medium uppercase tracking-[0.14em] text-slate-500">
                    Overview
                </p>
                <p class="text-sm text-slate-500">
                    Showing
                    <span class="font-semibold text-slate-900">
                        {{ leaves.start_index }}–{{ leaves.end_index }}
                    </span>
                    of
                    <span class="font-semibold text-slate-900">
                        {{ leaves.paginator.count }}
                    </span>
                    leaves.
                </p>
            </div>

            <div class="w-full sm:w-auto">
                <label class="relative block">
                    <span class="sr-only">Search leaves</span>
                    <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-slate-400">
                        <i class="fa-solid fa-magnifying-glass text-xs"></i>
                    </span>
                    <input
                        id="leaveSearch"
                        type="text"
                        placeholder="Search by worker, category, or status…"
                        class="w-full sm:w-64 rounded-lg border border-slate-200 bg-white px-8 py-2 text-xs sm:text-sm
                               text-slate-700 placeholder:text-slate-400 shadow-sm
                               focus:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-500/50">
                </label>
            </div>
        </div>

        <div class="overflow-x-auto border-t border-slate-100">
            <table class="min-w-full text-left text-sm text-slate-700">
                <thead class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-xs uppercase tracking-wide text-slate-100">
                    <tr>
                        <th class="px-4 py-3 font-medium">Worker</th>
                        <th class="px-4 py-3 font-medium">Category</th>
                        <th class="px-4 py-3 font-medium text-center">Status</th>
                        <th class="px-4 py-3 font-medium text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="leavesTableBody" class="divide-y divide-slate-100 bg-white">
                    {% for l in leaves %}
                    <tr class="hover:bg-slate-50/80 transition-colors">
                        <td class="px-4 py-3 align-middle text-sm font-semibold text-slate-900 truncate">
                            {{ l.worker.name }}
                        </td>
                        <td class="px-4 py-3 align-middle">
                            <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[11px] font-semibold
                                {% if l.category == 'Casual' %} bg-slate-50 text-slate-700 ring-1 ring-slate-100 {% endif %}
                                {% if l.category == 'Sick' %} bg-amber-50 text-amber-700 ring-1 ring-amber-100 {% endif %}
                                {% if l.category == 'Emergency' %} bg-indigo-50 text-indigo-700 ring-1 ring-indigo-100 {% endif %}">
                                {{ l.category }}
                            </span>
                        </td>
                        <td class="px-4 py-3 align-middle text-center">
                            <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[11px] font-semibold
                                {% if l.status == 'Pending' %} bg-amber-50 text-amber-700 ring-1 ring-amber-100 {% endif %}
                                {% if l.status == 'Approved' %} bg-emerald-50 text-emerald-700 ring-1 ring-emerald-100 {% endif %}
                                {% if l.status == 'Rejected' %} bg-rose-50 text-rose-700 ring-1 ring-rose-100 {% endif %}">
                                {{ l.status }}
                            </span>
                        </td>
                        <td class="px-4 py-3 align-middle text-center">
                            <div class="inline-flex items-center justify-center gap-2">
                                <button
                                    onclick="openLeaveView(
                                        '{{ l.worker.name|escapejs }}',
                                        '{{ l.start_date }}',
                                        '{{ l.end_date }}',
                                        '{{ l.start_time|time:"H:i" }}',
                                        '{{ l.end_time|time:"H:i" }}',
                                        '{{ l.category }}',
                                        '{{ l.reason|default:""|escapejs }}',
                                        '{{ l.status }}'
                                    )"
                                    class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-emerald-200 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 hover:border-emerald-300 transition"
                                    title="View">
                                    <i class="fa-solid fa-eye text-xs"></i>
                                    <span class="sr-only">View</span>
                                </button>
                                <button type="button"
                                    data-leave-toggle
                                    data-approve-url="{% url 'approve_leave' l.id %}"
                                    data-reject-url="{% url 'reject_leave' l.id %}"
                                    data-initial="{{ l.status }}"
                                    class="relative h-7 w-14 rounded-full bg-gray-300 transition-colors align-middle">
                                    <span data-knob class="absolute left-1 top-1 h-5 w-5 rounded-full bg-white shadow transition-transform"></span>
                                </button>
                                <button
                                    onclick="openLeaveEdit(
                                        '{% url 'edit_leave_admin' l.id %}',
                                        '{{ l.start_date|date:"Y-m-d" }}',
                                        '{{ l.end_date|date:"Y-m-d" }}',
                                        '{{ l.start_time|time:"H:i" }}',
                                        '{{ l.end_time|time:"H:i" }}',
                                        '{{ l.category }}',
                                        '{{ l.reason|default:""|escapejs }}',
                                        '{{ l.status }}'
                                    )"
                                    class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-sky-200 bg-sky-50 text-sky-700 hover:bg-sky-100 hover:border-sky-300 transition"
                                    title="Edit">
                                    <i class="fa-solid fa-pen-to-square text-xs"></i>
                                    <span class="sr-only">Edit</span>
                                </button>
                                <button
                                    onclick="openLeaveDelete('{% url 'delete_leave_admin' l.id %}')"
                                    class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-rose-200 bg-rose-50 text-rose-700 hover:bg-rose-100 hover:border-rose-300 transition"
                                    title="Delete">
                                    <i class="fa-solid fa-trash text-xs"></i>
                                    <span class="sr-only">Delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-4 py-10 text-center text-slate-500">No leave requests.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</main>

<div id="leaveViewModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 px-3 sm:px-6">
    <div class="bg-white w-full max-w-2xl rounded-xl p-5 sm:p-6 relative">
        <button onclick="closeLeaveView()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">✖</button>
        <div class="space-y-4">
            <div>
                <p class="text-xs font-medium text-slate-500">Worker</p>
                <p id="lvWorker" class="text-sm font-semibold text-slate-900"></p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <p class="text-xs font-medium text-slate-500">Start date</p>
                    <p id="lvStartDate" class="text-sm text-slate-800"></p>
                </div>
                <div>
                    <p class="text-xs font-medium text-slate-500">End date</p>
                    <p id="lvEndDate" class="text-sm text-slate-800"></p>
                </div>
                <div>
                    <p class="text-xs font-medium text-slate-500">Start time</p>
                    <p id="lvStartTime" class="text-sm text-slate-800">—</p>
                </div>
                <div>
                    <p class="text-xs font-medium text-slate-500">End time</p>
                    <p id="lvEndTime" class="text-sm text-slate-800">—</p>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <p class="text-xs font-medium text-slate-500">Category</p>
                    <p id="lvCategory" class="text-sm text-slate-800"></p>
                </div>
                <div>
                    <p class="text-xs font-medium text-slate-500">Status</p>
                    <p id="lvStatus" class="text-sm text-slate-800"></p>
                </div>
            </div>
            <div>
                <p class="text-xs font-medium text-slate-500">Reason</p>
                <p id="lvReason" class="text-sm text-slate-800 whitespace-pre-wrap"></p>
            </div>
        </div>
    </div>
</div>

<div id="leaveEditModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 px-3 sm:px-6">
    <div class="relative w-full max-w-md rounded-2xl bg-white shadow-xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between border-b border-slate-100 px-4 py-3 sm:px-6 sm:py-4 bg-slate-50/60 rounded-t-2xl">
            <div>
                <h2 class="text-base sm:text-lg font-semibold text-slate-900">Edit Leave</h2>
                <p class="text-xs text-slate-500">Update the leave details</p>
            </div>
            <button onclick="closeLeaveEdit()" class="rounded-lg p-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <form id="leaveEditForm" method="POST" action="#" class="p-4 sm:p-6 space-y-4">
            {% csrf_token %}
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Start date</label>
                    <input id="leStart" type="date" name="start_date" required class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">End date</label>
                    <input id="leEnd" type="date" name="end_date" required class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Start time</label>
                    <input id="leStartTime" type="time" name="start_time" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">End time</label>
                    <input id="leEndTime" type="time" name="end_time" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                    <select id="leCategory" name="category" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
                        <option value="Casual">Casual</option>
                        <option value="Sick">Sick</option>
                        <option value="Emergency">Emergency</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                    <select id="leStatus" name="status" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Reason</label>
                <textarea id="leReason" name="reason" rows="3" class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300" placeholder="Optional"></textarea>
            </div>
            <div class="flex items-center justify-end gap-3 border-t border-slate-100 pt-4">
                <button type="button" onclick="closeLeaveEdit()" class="px-4 py-2 text-sm bg-slate-200 rounded hover:bg-slate-300">Cancel</button>
                <button class="px-4 py-2 text-sm bg-slate-900 text-white rounded hover:bg-slate-800">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="leaveDeleteModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 px-3 sm:px-6">
    <div class="w-full max-w-sm bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-3">Confirm Delete</h2>
        <p class="text-sm text-gray-600 mb-6">Are you sure you want to delete this leave?</p>
        <div class="flex justify-end gap-3">
            <button type="button" onclick="closeLeaveDelete()" class="px-4 py-2 text-sm bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
            <a id="confirmLeaveDeleteBtn" class="px-4 py-2 text-sm bg-red-600 text-white rounded hover:bg-red-700">Delete</a>
        </div>
    </div>
</div>

<script>
function openLeaveView(worker, start, end, startTime, endTime, category, reason, status) {
    const m = document.getElementById('leaveViewModal');
    document.getElementById('lvWorker').innerText = worker || '';
    document.getElementById('lvStartDate').innerText = start || '';
    document.getElementById('lvEndDate').innerText = end || '';
    document.getElementById('lvStartTime').innerText = startTime || '—';
    document.getElementById('lvEndTime').innerText = endTime || '—';
    document.getElementById('lvCategory').innerText = category || '';
    document.getElementById('lvStatus').innerText = status || '';
    document.getElementById('lvReason').innerText = reason || '';
    m.classList.remove('hidden');
    m.classList.add('flex');
}
function closeLeaveView() {
    const m = document.getElementById('leaveViewModal');
    m.classList.add('hidden');
}
function openLeaveEdit(url, start, end, startTime, endTime, category, reason, status) {
    const m = document.getElementById('leaveEditModal');
    const f = document.getElementById('leaveEditForm');
    m.classList.remove('hidden');
    m.classList.add('flex');
    f.action = url;
    document.getElementById('leStart').value = start || '';
    document.getElementById('leEnd').value = end || '';
    document.getElementById('leStartTime').value = startTime || '';
    document.getElementById('leEndTime').value = endTime || '';
    document.getElementById('leCategory').value = category || 'Casual';
    document.getElementById('leReason').value = reason || '';
    document.getElementById('leStatus').value = status || 'Pending';
}
function closeLeaveEdit() {
    const m = document.getElementById('leaveEditModal');
    m.classList.add('hidden');
}
function openLeaveDelete(deleteUrl) {
    const m = document.getElementById('leaveDeleteModal');
    const b = document.getElementById('confirmLeaveDeleteBtn');
    m.classList.remove('hidden');
    m.classList.add('flex');
    b.href = deleteUrl;
}
function closeLeaveDelete() {
    const m = document.getElementById('leaveDeleteModal');
    m.classList.add('hidden');
}
document.querySelectorAll('[data-leave-toggle]').forEach(el => {
    const initial = (el.dataset.initial || '').trim();
    const on = initial === 'Approved';
    const knob = el.querySelector('[data-knob]');
    function setState(active, rejected) {
        el.classList.remove('bg-gray-200','bg-emerald-500','bg-rose-500','bg-gray-300');
        if (active) {
            el.classList.add('bg-emerald-500');
            knob.classList.add('translate-x-7');
        } else {
            knob.classList.remove('translate-x-7');
            if (rejected) {
                el.classList.add('bg-rose-500');
            } else {
                el.classList.add('bg-gray-300');
            }
        }
    }
    setState(on, initial === 'Rejected');
    el.addEventListener('click', () => {
        const isActive = knob.classList.contains('translate-x-7');
        const targetUrl = isActive ? el.dataset.rejectUrl : el.dataset.approveUrl;
        window.location.href = targetUrl;
    });
});
const leaveSearchInput = document.getElementById('leaveSearch');
const leavesTBody = document.getElementById('leavesTableBody');
let noMatchRowLeaves = null;
function ensureNoMatchRowLeaves() {
    if (!noMatchRowLeaves) {
        noMatchRowLeaves = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 4;
        td.className = 'px-4 py-6 text-center text-slate-500';
        td.innerText = 'No matching leaves.';
        noMatchRowLeaves.appendChild(td);
    }
}
if (leaveSearchInput && leavesTBody) {
    leaveSearchInput.addEventListener('input', function () {
        const q = this.value.trim().toLowerCase();
        const rows = Array.from(leavesTBody.querySelectorAll('tr'));
        let visibleCount = 0;
        rows.forEach(row => {
            const txt = row.textContent.toLowerCase();
            const show = q === '' || txt.includes(q);
            row.style.display = show ? '' : 'none';
            if (show) visibleCount += 1;
        });
        ensureNoMatchRowLeaves();
        if (visibleCount === 0) {
            if (noMatchRowLeaves.parentElement !== leavesTBody) leavesTBody.appendChild(noMatchRowLeaves);
        } else {
            if (noMatchRowLeaves.parentElement === leavesTBody) leavesTBody.removeChild(noMatchRowLeaves);
        }
    });
}
</script>
{% endblock %}
